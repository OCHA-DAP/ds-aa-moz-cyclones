---
jupyter:
  jupytext:
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.16.4
  kernelspec:
    display_name: .venv
    language: python
    name: python3
---

# Reviewing rainfall levels by region for cyclone Chido


This notebook reviews how far from the rainfall trigger cyclone Chido was.

```python
%load_ext jupyter_black
%load_ext autoreload
%autoreload 2
```

```python
from pathlib import Path

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

from src.datasources import codab, imerg
from src.constants import *
from src.utils import *
from src import db_utils
```

```python
adm1 = codab.load_codab(admin_level=1)
```

```python
aoi_adm1_pcodes = adm1["ADM1_PCODE"].unique()
aoi_adm1_pcodes.shape
```

```python
# this is from Meteo-France site
landfall_df = pd.DataFrame(
    {
        "NAME": ["CHIDO"],
        "LON": [40.58],
        "LAT": [-13.37],
        "landfall_date": [pd.to_datetime("2024-12-15")],
    }
)
landfall_df
```

```python
IMERG_START_DATE = pd.to_datetime("2000-06-01")
extra_days = 1
dfs = []
for sid, row in landfall_df.set_index("NAME").iterrows():
    landfall_date = row["landfall_date"]
    start_date = landfall_date - pd.Timedelta(days=extra_days)
    end_date = landfall_date + pd.Timedelta(days=extra_days)
    if end_date < IMERG_START_DATE:
        print(f"{row['NAME']} too early")
        continue
    df_in = imerg.fetch_imerg_data(aoi_adm1_pcodes, start_date, end_date)
    df_in["NAME"] = sid
    dfs.append(df_in)
```

```python
end_date
```

```python
imerg_df = pd.concat(dfs, ignore_index=True)
imerg_df
```

```python
adm_mean_sum = imerg_df.groupby("pcode")["mean"].sum().reset_index()
adm1_rain = adm1.merge(
    adm_mean_sum, left_on="ADM1_PCODE", right_on="pcode", how="left"
)
```

```python
fig, ax = plt.subplots(1, 1, figsize=(10, 8))

adm1_rain.plot(
    column="mean",
    cmap="BuPu",
    legend=True,
    legend_kwds={"label": "Sum of Rainfall (mm)"},
    edgecolor="black",
    ax=ax,
)
ax.set_title(
    "Cyclone Chido: Sum of Rainfall on the -1,0,1 days around landfall",
    fontsize=14,
)
plt.show()
```

```python
imerg_data = imerg_df.merge(
    adm1[["ADM1_PCODE", "ADM1_PT"]],
    left_on="pcode",
    right_on="ADM1_PCODE",
    how="left",
)
imerg_data = imerg_data[imerg_data["ADM1_PT"].isin(ADMS)]
fig, ax = plt.subplots(dpi=200, figsize=(8, 5))

imerg_data["name_index"] = pd.factorize(imerg_data["ADM1_PT"])[0]
number_dates = imerg_data["valid_date"].nunique()

imerg_pivot = imerg_data.pivot_table(
    index="name_index",
    columns="valid_date",
    values="mean",
    aggfunc="sum",
    fill_value=0,
)

imerg_pivot.plot(kind="bar", stacked=True, ax=ax, cmap="Paired")

middle_date = imerg_pivot.columns[1]

for i, row in imerg_pivot.iterrows():
    total = row.sum()
    ax.text(
        i,
        total + 2,
        f"{total:.0f}",
        ha="center",
        va="bottom",
        fontsize=10,
        color="black",
    )

ax.axhline(RAIN_THRESH, color="crimson", linestyle="--")

ax.annotate(
    f"Threshold: {RAIN_THRESH} mm",
    xy=(-0.2, RAIN_THRESH),
    fontsize=10,
    color="crimson",
    ha="left",
    va="bottom",
)

ax.set_xticks(range(len(imerg_pivot)))
ax.set_xticklabels(imerg_data["ADM1_PT"].unique(), rotation=90)
ax.legend(title="Date")

ax.set_xlabel("Province")
ax.set_ylabel(
    f"Total precipitation over {number_dates} days,\n"
    f"averaged over the province, around {middle_date} (mm)"
)
ax.set_title(
    f"Total precipitation over {number_dates} days, around {middle_date}"
)
ax.spines["top"].set_visible(False)
ax.spines["right"].set_visible(False)
plt.show()
```
